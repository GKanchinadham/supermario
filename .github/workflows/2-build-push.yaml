name: "Phase 2: Build & Push Image"

on:
  workflow_dispatch:
    inputs:
      tenant_name:
        description: 'Tenant/Organization'
        required: true
        default: 'luigi'
      app_name:
        description: 'Application name'
        required: true
        default: 'luigi-app'
      app_region:
        description: 'AWS Region'
        required: true
        default: 'eu-west-2'

env:
  TENANT_NAME: ${{ github.event.inputs.tenant_name }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  APP_REGION: ${{ github.event.inputs.app_region }}

permissions:
  contents: write
  id-token: write

jobs:
  # ==========================================
  # Phase 2A: Verify Infrastructure
  # ==========================================
  verify-infra:
    name: "üîç Verify Infrastructure"
    runs-on: ubuntu-latest
    outputs:
      cluster_name: ${{ steps.verify.outputs.cluster_name }}
      ecr_uri: ${{ steps.verify.outputs.ecr_uri }}
      ecr_registry: ${{ steps.verify.outputs.ecr_registry }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Verify Infrastructure Exists
        id: verify
        run: |
          echo "========================================"
          echo "üîç VERIFYING PHASE 1 INFRASTRUCTURE"
          echo "========================================"
          
          CLUSTER_NAME="${{ env.TENANT_NAME }}-${{ env.APP_REGION }}-nonprod"
          ECR_REPO="${{ env.TENANT_NAME }}/${{ env.APP_NAME }}"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.APP_REGION }}.amazonaws.com"
          ECR_URI="${ECR_REGISTRY}/${ECR_REPO}"
          
          # Verify EKS
          echo "Checking EKS Cluster: $CLUSTER_NAME..."
          if aws eks describe-cluster --name "$CLUSTER_NAME" 2>/dev/null; then
            echo "‚úÖ EKS Cluster exists"
          else
            echo "‚ùå EKS Cluster NOT FOUND - Run Phase 1 first!"
            exit 1
          fi
          
          # Verify ECR
          echo "Checking ECR Repository: $ECR_REPO..."
          if aws ecr describe-repositories --repository-names "$ECR_REPO" 2>/dev/null; then
            echo "‚úÖ ECR Repository exists"
          else
            echo "‚ùå ECR Repository NOT FOUND - Run Phase 1 first!"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All Phase 1 infrastructure verified"
          
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT
          echo "ecr_registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT

  # ==========================================
  # Phase 2B: Build & Push Docker Image
  # ==========================================
  build-push:
    name: "üê≥ Build & Push Image"
    runs-on: ubuntu-latest
    needs: verify-infra
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      full_image: ${{ steps.build.outputs.full_image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Image
        id: build
        run: |
          ECR_REGISTRY="${{ needs.verify-infra.outputs.ecr_registry }}"
          ECR_REPO="${{ env.TENANT_NAME }}/${{ env.APP_NAME }}"
          IMAGE_TAG="${{ github.sha }}"
          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"
          
          echo "========================================"
          echo "üê≥ BUILDING DOCKER IMAGE"
          echo "========================================"
          echo "Image: $FULL_IMAGE"
          
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            -t $FULL_IMAGE \
            -t ${ECR_REGISTRY}/${ECR_REPO}:latest \
            .
          
          echo ""
          echo "========================================"
          echo "üì§ PUSHING TO ECR"
          echo "========================================"
          
          docker push $FULL_IMAGE
          docker push ${ECR_REGISTRY}/${ECR_REPO}:latest
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================"
          echo "‚úÖ IMAGE PUSHED SUCCESSFULLY"
          echo "========================================"
          echo "Image: $FULL_IMAGE"

      - name: Phase 2 Summary
        run: |
          echo "## üê≥ Phase 2: Build & Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.build.outputs.full_image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.build.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ‚úÖ Pushed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Run Phase 3 workflow to deploy to EKS" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Phase 2C: Security Scan (Grype)
  # ==========================================
  security-scan:
    name: "üõ°Ô∏è Security Scan"
    runs-on: ubuntu-latest
    needs: [verify-infra, build-push]
    continue-on-error: true
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Security Scan
        run: |
          echo "========================================"
          echo "üõ°Ô∏è SECURITY SCAN"
          echo "========================================"
          
          grype ${{ needs.build-push.outputs.full_image }} -o table
          
          echo ""
          echo "‚úÖ Security scan completed"
