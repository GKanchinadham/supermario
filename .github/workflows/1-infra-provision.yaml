name: "Phase 1: Infrastructure Provisioning"

on:
  workflow_dispatch:
    inputs:
      tenant_name:
        description: 'Tenant/Organization'
        required: true
        default: 'luigi'
      app_name:
        description: 'Application name'
        required: true
        default: 'luigi-app'
      app_env:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      app_region:
        description: 'AWS Region'
        required: true
        default: 'eu-west-2'

env:
  TENANT_NAME: ${{ github.event.inputs.tenant_name }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  APP_ENV: ${{ github.event.inputs.app_env }}
  APP_REGION: ${{ github.event.inputs.app_region }}

permissions:
  contents: write
  id-token: write

jobs:
  # ==========================================
  # Phase 1A: Create EKS Cluster
  # ==========================================
  create-eks:
    name: "ðŸ—ï¸ Phase 1A: Create EKS Cluster"
    runs-on: ubuntu-latest
    outputs:
      cluster_name: ${{ steps.setup.outputs.cluster_name }}
      cluster_exists: ${{ steps.check.outputs.exists }}
      cluster_endpoint: ${{ steps.create.outputs.endpoint }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Setup Variables
        id: setup
        run: |
          if [ "${{ env.APP_ENV }}" = "prod" ]; then
            CLUSTER_ENV="prod"
          else
            CLUSTER_ENV="nonprod"
          fi
          
          CLUSTER_NAME="${{ env.TENANT_NAME }}-${{ env.APP_REGION }}-${CLUSTER_ENV}"
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "cluster_env=$CLUSTER_ENV" >> $GITHUB_OUTPUT
          
          echo "========================================"
          echo "ðŸ“‹ INFRASTRUCTURE SETUP"
          echo "========================================"
          echo "Cluster Name: $CLUSTER_NAME"
          echo "Region: ${{ env.APP_REGION }}"
          echo "Environment: $CLUSTER_ENV"

      - name: Check if EKS Cluster Exists
        id: check
        run: |
          CLUSTER_NAME="${{ steps.setup.outputs.cluster_name }}"
          
          if aws eks describe-cluster --name "$CLUSTER_NAME" --region ${{ env.APP_REGION }} 2>/dev/null; then
            echo "âœ… Cluster $CLUSTER_NAME already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            ENDPOINT=$(aws eks describe-cluster --name "$CLUSTER_NAME" --query 'cluster.endpoint' --output text)
            echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          else
            echo "âŒ Cluster $CLUSTER_NAME does not exist - will create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install eksctl
        if: steps.check.outputs.exists == 'false'
        run: |
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version

      - name: Create EKS Cluster
        id: create
        if: steps.check.outputs.exists == 'false'
        run: |
          CLUSTER_NAME="${{ steps.setup.outputs.cluster_name }}"
          
          echo "========================================"
          echo "ðŸ—ï¸ CREATING EKS CLUSTER: $CLUSTER_NAME"
          echo "========================================"
          
          cat > /tmp/cluster-config.yaml << EOF
          apiVersion: eksctl.io/v1alpha5
          kind: ClusterConfig
          
          metadata:
            name: ${CLUSTER_NAME}
            region: ${{ env.APP_REGION }}
            version: "1.28"
          
          managedNodeGroups:
            - name: workers
              instanceType: t3.medium
              desiredCapacity: 2
              minSize: 1
              maxSize: 4
              volumeSize: 50
              ssh:
                allow: false
              labels:
                role: workers
              tags:
                Tenant: ${{ env.TENANT_NAME }}
                Environment: ${{ steps.setup.outputs.cluster_env }}
          
          cloudWatch:
            clusterLogging:
              enableTypes: ["api", "audit", "authenticator"]
          EOF
          
          cat /tmp/cluster-config.yaml
          
          echo ""
          echo "Starting cluster creation (this takes 15-20 minutes)..."
          eksctl create cluster -f /tmp/cluster-config.yaml
          
          # Get endpoint
          ENDPOINT=$(aws eks describe-cluster --name "$CLUSTER_NAME" --query 'cluster.endpoint' --output text)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================"
          echo "âœ… EKS CLUSTER CREATED SUCCESSFULLY"
          echo "========================================"
          echo "Cluster: $CLUSTER_NAME"
          echo "Endpoint: $ENDPOINT"

      - name: Verify Cluster
        run: |
          CLUSTER_NAME="${{ steps.setup.outputs.cluster_name }}"
          
          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region ${{ env.APP_REGION }}
          
          echo "Cluster nodes:"
          kubectl get nodes
          
          echo ""
          echo "Cluster info:"
          kubectl cluster-info

      - name: Phase 1A Summary
        run: |
          echo "## ðŸ—ï¸ Phase 1A: EKS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | \`${{ steps.setup.outputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.APP_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Ready |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Phase 1B: Create ECR Repository
  # ==========================================
  create-ecr:
    name: "ðŸ“¦ Phase 1B: Create ECR Repository"
    runs-on: ubuntu-latest
    needs: create-eks
    outputs:
      ecr_uri: ${{ steps.create.outputs.ecr_uri }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Create ECR Repository
        id: create
        run: |
          ECR_REPO="${{ env.TENANT_NAME }}/${{ env.APP_NAME }}"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.APP_REGION }}.amazonaws.com/${ECR_REPO}"
          
          echo "========================================"
          echo "ðŸ“¦ ECR REPOSITORY SETUP"
          echo "========================================"
          echo "Repository: $ECR_REPO"
          echo "URI: $ECR_URI"
          
          # Check if exists
          if aws ecr describe-repositories --repository-names "$ECR_REPO" 2>/dev/null; then
            echo "âœ… ECR Repository already exists"
          else
            echo "Creating ECR Repository..."
            aws ecr create-repository \
              --repository-name "$ECR_REPO" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "âœ… ECR Repository created"
          fi
          
          echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT

      - name: Phase 1B Summary
        run: |
          echo "## ðŸ“¦ Phase 1B: ECR Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ env.TENANT_NAME }}/${{ env.APP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URI | \`${{ steps.create.outputs.ecr_uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Ready |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Phase 1C: Install ArgoCD
  # ==========================================
  install-argocd:
    name: "ðŸ”„ Phase 1C: Install ArgoCD"
    runs-on: ubuntu-latest
    needs: [create-eks, create-ecr]
    outputs:
      argocd_url: ${{ steps.install.outputs.argocd_url }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.APP_REGION }}

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name "${{ needs.create-eks.outputs.cluster_name }}" --region ${{ env.APP_REGION }}

      - name: Install ArgoCD
        id: install
        run: |
          echo "========================================"
          echo "ðŸ”„ ARGOCD INSTALLATION"
          echo "========================================"
          
          # Create namespace
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
          
          # Install ArgoCD
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          echo "Waiting for ArgoCD pods to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd || true
          
          # Get ArgoCD password
          echo "ArgoCD initial admin password:"
          kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo
          
          # Expose ArgoCD (LoadBalancer for cloud access)
          kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
          
          echo "Waiting for LoadBalancer..."
          sleep 60
          
          ARGOCD_URL=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "argocd_url=$ARGOCD_URL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================"
          echo "âœ… ARGOCD INSTALLED"
          echo "========================================"
          echo "URL: https://$ARGOCD_URL"

      - name: Phase 1C Summary
        run: |
          echo "## ðŸ”„ Phase 1C: ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | \`argocd\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Installed |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Phase 1 Complete Summary
  # ==========================================
  phase1-complete:
    name: "âœ… Phase 1 Complete"
    runs-on: ubuntu-latest
    needs: [create-eks, create-ecr, install-argocd]
    
    steps:
      - name: Phase 1 Summary
        run: |
          echo "========================================"
          echo "âœ… PHASE 1 INFRASTRUCTURE COMPLETE"
          echo "========================================"
          echo ""
          echo "EKS Cluster: ${{ needs.create-eks.outputs.cluster_name }}"
          echo "ECR URI: ${{ needs.create-ecr.outputs.ecr_uri }}"
          echo "ArgoCD: Installed"
          echo ""
          echo "========================================"
          echo "âž¡ï¸ PROCEED TO PHASE 2: Build & Push Image"
          echo "========================================"
          
          echo "## âœ… Phase 1 Complete - Infrastructure Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| EKS Cluster | âœ… \`${{ needs.create-eks.outputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Repository | âœ… \`${{ needs.create-ecr.outputs.ecr_uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD | âœ… Installed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Run Phase 2 workflow to build and push the Docker image" >> $GITHUB_STEP_SUMMARY
