# Deploy application manifests to the cluster
name: Deploy Application

on:
  workflow_dispatch:

env:
  CLUSTER_NAME: gkorg-usw2-np
  NAMESPACE: gkorgapp1-dev
  AWS_REGION: us-west-2
  ECR_REPO: gkorg/gkorgapp1

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: aws
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          echo "account_id=$AWS_ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "ecr_registry=${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Update Kustomization with ECR Image
        run: |
          ECR_REGISTRY="${{ steps.aws.outputs.ecr_registry }}"
          
          cd k8s/overlays/dev
          
          # Update the image reference to use full ECR path
          cat > kustomization.yaml << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          metadata:
            name: gkorgapp1-dev

          namespace: gkorgapp1-dev

          resources:
            - ../../base

          commonLabels:
            environment: dev

          images:
            - name: gkorg/gkorgapp1
              newName: ${ECR_REGISTRY}/${{ env.ECR_REPO }}
              newTag: latest

          patches:
            - target:
                kind: Deployment
                name: gkorgapp1
              patch: |-
                - op: replace
                  path: /spec/replicas
                  value: 1
                - op: replace
                  path: /spec/template/spec/containers/0/resources/requests/memory
                  value: "128Mi"
                - op: replace
                  path: /spec/template/spec/containers/0/resources/requests/cpu
                  value: "100m"
                - op: replace
                  path: /spec/template/spec/containers/0/resources/limits/memory
                  value: "256Mi"
                - op: replace
                  path: /spec/template/spec/containers/0/resources/limits/cpu
                  value: "500m"
          EOF
          
          echo "Updated kustomization.yaml:"
          cat kustomization.yaml

      - name: Create/Update AWS Credentials Secret
        run: |
          kubectl delete secret aws-credentials -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl create secret generic aws-credentials \
            --namespace ${{ env.NAMESPACE }} \
            --from-literal=AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --from-literal=AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "âœ… AWS credentials secret created"

      - name: Apply Kustomize Manifests
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  APPLYING KUBERNETES MANIFESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Preview what will be applied
          echo "Manifests to apply:"
          kubectl kustomize k8s/overlays/dev
          
          echo ""
          echo "Applying manifests..."
          kubectl apply -k k8s/overlays/dev
          
          echo "âœ… Manifests applied successfully"

      - name: Wait for Deployment
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  WAITING FOR DEPLOYMENT TO BE READY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          kubectl rollout status deployment/gkorgapp1 -n ${{ env.NAMESPACE }} --timeout=300s || true
          
          echo ""
          echo "Pod Status:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

      - name: Get LoadBalancer URL
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  SERVICE AND LOADBALANCER STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          kubectl get svc -n ${{ env.NAMESPACE }}
          
          echo ""
          echo "Waiting for LoadBalancer to be assigned (up to 3 minutes)..."
          
          for i in {1..18}; do
            LB_URL=$(kubectl get svc gkorgapp1-dev -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
            if [ -n "$LB_URL" ]; then
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "  ðŸŽ® YOUR APPLICATION IS LIVE!"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "  ðŸŒ URL: http://$LB_URL"
              echo ""
              echo "  Testing health endpoint..."
              sleep 10
              curl -s -o /dev/null -w "  HTTP Status: %{http_code}\n" "http://$LB_URL/health" --max-time 10 || echo "  â³ Still starting up..."
              echo ""
              
              # Write to summary
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ® Super Mario Task Tracker - LIVE!
          
          | Property | Value |
          |----------|-------|
          | **Application URL** | http://$LB_URL |
          | **Health Check** | http://$LB_URL/health |
          | **Cluster** | ${{ env.CLUSTER_NAME }} |
          | **Namespace** | ${{ env.NAMESPACE }} |
          | **Region** | ${{ env.AWS_REGION }} |
          EOF
              exit 0
            fi
            echo "  Attempt $i/18 - LoadBalancer pending..."
            sleep 10
          done
          
          echo "â³ LoadBalancer still pending. It may take a few more minutes."
          kubectl describe svc gkorgapp1-dev -n ${{ env.NAMESPACE }}

      - name: Final Status
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  FINAL DEPLOYMENT STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Pods:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "Services:"
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo ""
          echo "Events:"
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -10
